{
  # Disable Automatic HTTPS globally (we terminate TLS at Cloudflare).
  auto_https off
}

# ===== Development (Vite Dev Server) =====
# Used when running the development environment via Docker Compose.
# Cloudflare Tunnel connects to this Caddy instance over plain HTTP (port 80).
http://dev.chrispicloud.dev {
  encode zstd gzip

  # Redirect /financetracker -> /financetracker/ (explicit, no matcher ambiguity)
  redir /financetracker /financetracker/ 308

  # API (strip prefix)
  handle_path /financetracker/api/* {
    reverse_proxy api:8080
  }

  # Frontend (no strip â€” Vite expects /financetracker/ as base path)
  handle /financetracker/* {
    reverse_proxy web:5173
  }

  # Default handler (useful for quick testing)
  handle {
    respond "FinanceTracker DEV gateway OK" 200
  }
}

# ===== Production (Static Build) =====
# Optional in your dev container. Kept here with HTTP only (no real certs).
http://chrispicloud.dev {
  encode zstd gzip

  # Redirect /financetracker -> /financetracker/ (explicit)
  redir /financetracker /financetracker/ 308

  # API (strip prefix)
  handle_path /financetracker/api/* {
    reverse_proxy api:8080
  }

  # Static SPA served from /srv/web (Caddy file server)
  handle_path /financetracker/* {
    root * /srv/web
    file_server
    try_files {path} /index.html
  }

  # Default handler for root path
  handle {
    respond "FinanceTracker PROD gateway OK" 200
  }
}
